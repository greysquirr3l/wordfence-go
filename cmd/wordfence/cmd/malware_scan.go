package cmd

import (
	"fmt"
	"os"

	"github.com/nickcampbell/wordfence-go/internal/logging"
	"github.com/spf13/cobra"
)

var (
	malwareScanOutput       string
	malwareScanOutputFormat string
	malwareScanWorkers      int
	malwareScanIncludeAll   bool
	malwareScanReadStdin    bool
)

var malwareScanCmd = &cobra.Command{
	Use:   "malware-scan [paths...]",
	Short: "Scan files for malware",
	Long: `Scan files and directories for malware using Wordfence signatures.

The scanner will recursively scan the specified paths for files matching
known malware signatures. By default, only PHP, HTML, and JS files are
scanned unless --include-all-files is specified.`,
	Example: `  # Scan a single directory
  wordfence malware-scan /var/www

  # Scan multiple directories
  wordfence malware-scan /var/www/site1 /var/www/site2

  # Scan with CSV output
  wordfence malware-scan --output-format csv --output results.csv /var/www

  # Scan files from stdin
  find /var/www -name "*.php" | wordfence malware-scan --read-stdin`,
	Args: func(cmd *cobra.Command, args []string) error {
		if !malwareScanReadStdin && len(args) == 0 {
			return fmt.Errorf("at least one path is required (or use --read-stdin)")
		}
		return nil
	},
	RunE: func(cmd *cobra.Command, args []string) error {
		return runMalwareScan(args)
	},
}

func init() {
	malwareScanCmd.Flags().StringVarP(&malwareScanOutput, "output", "o", "", "output file (default: stdout)")
	malwareScanCmd.Flags().StringVar(&malwareScanOutputFormat, "output-format", "human", "output format: csv, tsv, json, human")
	malwareScanCmd.Flags().IntVarP(&malwareScanWorkers, "workers", "w", 0, "number of worker goroutines (default: NumCPU)")
	malwareScanCmd.Flags().BoolVar(&malwareScanIncludeAll, "include-all-files", false, "scan all files, not just PHP/HTML/JS")
	malwareScanCmd.Flags().BoolVar(&malwareScanReadStdin, "read-stdin", false, "read paths from stdin")

	rootCmd.AddCommand(malwareScanCmd)
}

func runMalwareScan(paths []string) error {
	cfg := GetConfig()
	if cfg == nil {
		return fmt.Errorf("configuration not loaded")
	}

	// Check for license
	if cfg.License == "" {
		logging.Error("No license key configured. Set WORDFENCE_CLI_LICENSE or use --license flag.")
		logging.Info("Visit https://www.wordfence.com/products/wordfence-cli/ to obtain a license.")
		os.Exit(1)
	}

	logging.Info("Starting malware scan...")
	logging.Debug("License: %s...", cfg.License[:minInt(8, len(cfg.License))])
	logging.Debug("Paths: %v", paths)
	logging.Debug("Workers: %d", malwareScanWorkers)
	logging.Debug("Include all files: %v", malwareScanIncludeAll)

	// TODO: Implement actual scanning
	// 1. Load signatures from API/cache
	// 2. Set up file filter
	// 3. Create scanner with worker pool
	// 4. Scan files and output results

	logging.Warning("Malware scanning not yet implemented")

	return nil
}

func minInt(a, b int) int {
	if a < b {
		return a
	}
	return b
}
